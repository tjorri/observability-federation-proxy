name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  KIND_VERSION: 'v0.24.0'
  CLUSTER_NAME: 'ofp-e2e'

jobs:
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Build proxy binary
        run: make build

      - name: Setup e2e infrastructure
        run: make e2e-setup
        env:
          CLUSTER_NAME: ${{ env.CLUSTER_NAME }}

      - name: Wait for deployments
        run: |
          export KUBECONFIG="${PWD}/e2e/kubeconfig"
          echo "==> Waiting for Loki..."
          kubectl wait --for=condition=available --timeout=180s deployment/loki -n observability
          echo "==> Waiting for Mimir..."
          kubectl wait --for=condition=available --timeout=180s deployment/mimir -n observability
          echo "==> Checking pod status..."
          kubectl get pods -n observability
          # Give services time to become fully ready
          sleep 10

      - name: Run e2e tests
        run: make e2e-run
        env:
          CLUSTER_NAME: ${{ env.CLUSTER_NAME }}

      - name: Collect logs on failure
        if: failure()
        run: |
          export KUBECONFIG="${PWD}/e2e/kubeconfig"
          echo "==> Loki logs"
          kubectl logs -n observability -l app=loki --tail=200 || true
          echo "==> Mimir logs"
          kubectl logs -n observability -l app=mimir --tail=200 || true
          echo "==> Pod status"
          kubectl get pods -A || true
          echo "==> Events"
          kubectl get events -n observability --sort-by='.lastTimestamp' || true

      - name: Teardown e2e infrastructure
        if: always()
        run: make e2e-teardown
        env:
          CLUSTER_NAME: ${{ env.CLUSTER_NAME }}
